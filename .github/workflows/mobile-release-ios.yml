# iOS 릴리즈 빌드 및 App Store 배포
name: iOS Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: iOS 릴리즈 빌드
    runs-on: macos-latest

    defaults:
      run:
        working-directory: mobile

    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v4

      - name: Node.js 설정
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: mobile/package-lock.json

      - name: 의존성 설치
        run: npm ci

      - name: .env.production 생성
        run: echo "${{ secrets.MOBILE_ENV_PROD }}" > .env.production

      - name: CocoaPods 설치
        run: |
          cd ios
          pod install

      - name: Apple 인증서 설치
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.IOS_DISTRIBUTION_CERT_P12_BASE64 }}
          p12-password: ${{ secrets.IOS_DISTRIBUTION_CERT_PASSWORD }}

      - name: Provisioning Profile 설치
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/distribution.mobileprovision

      - name: iOS 아카이브 빌드
        run: |
          cd ios
          xcodebuild -workspace mobile.xcworkspace \
            -scheme mobile \
            -configuration Release \
            -archivePath $RUNNER_TEMP/mobile.xcarchive \
            archive \
            CODE_SIGN_IDENTITY="${{ secrets.IOS_CODE_SIGN_IDENTITY }}" \
            PROVISIONING_PROFILE_SPECIFIER="${{ secrets.IOS_PROVISIONING_PROFILE_NAME }}" \
            DEVELOPMENT_TEAM="${{ secrets.IOS_TEAM_ID }}"

      - name: ExportOptions.plist 생성
        run: |
          cat > $RUNNER_TEMP/ExportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
              <key>teamID</key>
              <string>${{ secrets.IOS_TEAM_ID }}</string>
              <key>uploadSymbols</key>
              <true/>
              <key>compileBitcode</key>
              <false/>
              <key>provisioningProfiles</key>
              <dict>
                  <key>com.tymee.app</key>
                  <string>${{ secrets.IOS_PROVISIONING_PROFILE_NAME }}</string>
              </dict>
          </dict>
          </plist>
          EOF

      - name: IPA 익스포트
        run: |
          xcodebuild -exportArchive \
            -archivePath $RUNNER_TEMP/mobile.xcarchive \
            -exportPath $RUNNER_TEMP/export \
            -exportOptionsPlist $RUNNER_TEMP/ExportOptions.plist

      - name: IPA 아티팩트 업로드
        uses: actions/upload-artifact@v4
        with:
          name: ios-release-ipa
          path: ${{ runner.temp }}/export/*.ipa
          retention-days: 30

  deploy:
    name: App Store 배포
    needs: build
    runs-on: macos-latest

    steps:
      - name: IPA 다운로드
        uses: actions/download-artifact@v4
        with:
          name: ios-release-ipa
          path: ./

      - name: App Store Connect 업로드
        run: |
          xcrun altool --upload-app \
            --type ios \
            --file *.ipa \
            --username "${{ secrets.APPLE_ID }}" \
            --password "${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}"
