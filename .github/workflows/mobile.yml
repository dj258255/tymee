# 모바일 CI/CD 통합 워크플로우
# 브랜치 전략:
#   - develop/staging 푸시 → Lint + TypeScript 체크
#   - master 푸시 → 내부 테스트 트랙 배포 (Internal/TestFlight)
#   - v* 태그 → 프로덕션 스토어 배포
name: Mobile

on:
  push:
    branches:
      - develop
      - staging
      - master
    paths:
      - 'mobile/**'
      - '.github/workflows/mobile.yml'
    tags:
      - 'v*'
  pull_request:
    branches:
      - develop
      - staging
      - master
    paths:
      - 'mobile/**'
  workflow_dispatch:
    inputs:
      deploy_target:
        description: '배포 대상'
        required: true
        default: 'none'
        type: choice
        options:
          - none
          - internal
          - production

jobs:
  # ===========================================
  # Lint & 타입 체크
  # ===========================================
  lint:
    name: Lint & 타입 체크
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: mobile

    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v4

      - name: Node.js 설정
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: mobile/package-lock.json

      - name: 의존성 설치
        run: npm ci

      - name: ESLint 실행
        run: npm run lint

      - name: TypeScript 타입 체크
        run: npx tsc --noEmit

  # ===========================================
  # Android 내부 테스트 배포 (master 푸시)
  # ===========================================
  deploy-android-internal:
    name: Android 내부 테스트 배포
    needs: lint
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/master') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_target == 'internal')

    defaults:
      run:
        working-directory: mobile

    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v4

      - name: Node.js 설정
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: mobile/package-lock.json

      - name: JDK 17 설정
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Ruby 설정
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: mobile

      - name: Fastlane 설치
        run: gem install fastlane

      - name: 의존성 설치
        run: npm ci

      - name: .env.production 생성
        run: echo "${{ secrets.MOBILE_ENV_PROD }}" > .env.production

      - name: Google Play JSON 키 생성
        run: echo '${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}' > fastlane/google-play-key.json

      - name: 키스토어 복원
        run: echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/tymee-release.keystore

      - name: Fastlane 배포
        run: fastlane android beta

  # ===========================================
  # iOS 내부 테스트 배포 (master 푸시 → TestFlight)
  # ===========================================
  deploy-ios-internal:
    name: iOS TestFlight 배포
    needs: lint
    runs-on: macos-latest
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/master') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_target == 'internal')

    defaults:
      run:
        working-directory: mobile

    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v4

      - name: Node.js 설정
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: mobile/package-lock.json

      - name: Ruby 설정
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: mobile

      - name: Fastlane 설치
        run: gem install fastlane

      - name: 의존성 설치
        run: npm ci

      - name: .env.production 생성
        run: echo "${{ secrets.MOBILE_ENV_PROD }}" > .env.production

      - name: App Store Connect API 키 생성
        run: echo '${{ secrets.APP_STORE_CONNECT_API_KEY }}' > fastlane/AuthKey.p8

      - name: CocoaPods 설치
        run: cd ios && pod install

      - name: HTTP 차단 설정 (배포용)
        run: |
          /usr/libexec/PlistBuddy -c "Set :NSAppTransportSecurity:NSAllowsArbitraryLoads false" ios/mobile/Info.plist

      - name: Apple 인증서 설치
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.IOS_DISTRIBUTION_CERT_P12_BASE64 }}
          p12-password: ${{ secrets.IOS_DISTRIBUTION_CERT_PASSWORD }}

      - name: Provisioning Profile 설치
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/distribution.mobileprovision

      - name: Fastlane 배포
        run: fastlane ios beta

  # ===========================================
  # Android 프로덕션 배포 (v* 태그)
  # ===========================================
  deploy-android-production:
    name: Android 프로덕션 배포
    needs: lint
    runs-on: ubuntu-latest
    if: |
      startsWith(github.ref, 'refs/tags/v') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_target == 'production')

    defaults:
      run:
        working-directory: mobile

    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v4

      - name: Node.js 설정
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: mobile/package-lock.json

      - name: JDK 17 설정
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Ruby 설정
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: mobile

      - name: Fastlane 설치
        run: gem install fastlane

      - name: 의존성 설치
        run: npm ci

      - name: .env.production 생성
        run: echo "${{ secrets.MOBILE_ENV_PROD }}" > .env.production

      - name: Google Play JSON 키 생성
        run: echo '${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}' > fastlane/google-play-key.json

      - name: 키스토어 복원
        run: echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/tymee-release.keystore

      - name: Fastlane 배포
        run: fastlane android release

  # ===========================================
  # iOS 프로덕션 배포 (v* 태그)
  # ===========================================
  deploy-ios-production:
    name: iOS 프로덕션 배포
    needs: lint
    runs-on: macos-latest
    if: |
      startsWith(github.ref, 'refs/tags/v') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_target == 'production')

    defaults:
      run:
        working-directory: mobile

    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v4

      - name: Node.js 설정
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: mobile/package-lock.json

      - name: Ruby 설정
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: mobile

      - name: Fastlane 설치
        run: gem install fastlane

      - name: 의존성 설치
        run: npm ci

      - name: .env.production 생성
        run: echo "${{ secrets.MOBILE_ENV_PROD }}" > .env.production

      - name: App Store Connect API 키 생성
        run: echo '${{ secrets.APP_STORE_CONNECT_API_KEY }}' > fastlane/AuthKey.p8

      - name: CocoaPods 설치
        run: cd ios && pod install

      - name: HTTP 차단 설정 (배포용)
        run: |
          /usr/libexec/PlistBuddy -c "Set :NSAppTransportSecurity:NSAllowsArbitraryLoads false" ios/mobile/Info.plist

      - name: Apple 인증서 설치
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.IOS_DISTRIBUTION_CERT_P12_BASE64 }}
          p12-password: ${{ secrets.IOS_DISTRIBUTION_CERT_PASSWORD }}

      - name: Provisioning Profile 설치
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/distribution.mobileprovision

      - name: Fastlane 배포
        run: fastlane ios release
