require 'dotenv'
Dotenv.load('../.env.production')

default_platform(:ios)

# App Store Connect API 키 설정
def api_key
  app_store_connect_api_key(
    key_id: ENV['APP_STORE_CONNECT_API_KEY_ID'],
    issuer_id: ENV['APP_STORE_CONNECT_API_ISSUER_ID'],
    key_filepath: ENV['APP_STORE_CONNECT_API_KEY_PATH'],
    in_house: false
  )
end

# iOS 배포
platform :ios do
  desc "Build and upload to App Store Connect (TestFlight)"
  lane :beta do
    setup_ci if ENV['CI']

    # 빌드 번호 증가
    increment_build_number(
      xcodeproj: "ios/mobile.xcodeproj"
    )

    # 앱 빌드
    build_app(
      workspace: "ios/mobile.xcworkspace",
      scheme: "mobile",
      configuration: "Release",
      export_method: "app-store",
      output_directory: "./build",
      output_name: "Tymee.ipa"
    )

    # TestFlight에 업로드
    upload_to_testflight(
      api_key: api_key,
      skip_waiting_for_build_processing: true
    )
  end

  desc "Build and upload to App Store (Production)"
  lane :release do
    setup_ci if ENV['CI']

    increment_build_number(
      xcodeproj: "ios/mobile.xcodeproj"
    )

    build_app(
      workspace: "ios/mobile.xcworkspace",
      scheme: "mobile",
      configuration: "Release",
      export_method: "app-store",
      output_directory: "./build",
      output_name: "Tymee.ipa"
    )

    upload_to_app_store(
      api_key: api_key,
      skip_screenshots: true,
      skip_metadata: true,
      submit_for_review: false
    )
  end
end

# Android 배포
platform :android do
  desc "Build and upload to Play Store (Internal Testing)"
  lane :beta do
    gradle(
      task: "bundle",
      build_type: "Release",
      project_dir: "android"
    )

    upload_to_play_store(
      track: "internal",
      aab: "android/app/build/outputs/bundle/release/app-release.aab",
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )
  end

  desc "Build and upload to Play Store (Production)"
  lane :release do
    gradle(
      task: "bundle",
      build_type: "Release",
      project_dir: "android"
    )

    upload_to_play_store(
      track: "production",
      aab: "android/app/build/outputs/bundle/release/app-release.aab",
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )
  end
end
